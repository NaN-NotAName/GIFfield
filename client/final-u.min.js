var tune=angular.module("Tunechat",["ngRoute","ngCookies"]);tune.config(function($routeProvider){$routeProvider.when("/home",{controller:"HomeController",templateUrl:"../views/min/home.html"}).when("/",{controller:"SplashController",templateUrl:"../views/min/splash.html"}).otherwise({redirectTo:"/"})}),tune.controller("HomeController",["$scope","socket","playerFactory","soundService","$cookies","userName",function($scope,socket,playerFactory,soundService,$cookies,userName){var songKeyTracker=0;$scope.pageClass="mainPage",socket.on("connect",function(){console.log("i connected")}),$scope.$on("$routeChangeSuccess",function(){var option=["Artists","Songs","Albums","Playlists"];return $scope.options=option[0],setInterval(function(){var popped=option.pop();$scope.options=popped,$scope.$apply(),option.unshift(popped)},2e3)}),$scope.playListFinal=[],$scope.rmvPlayListItem=function(event){socket.emit("removeSong",{id:event}),console.log(event.key),console.log($scope.playListFinal[0].id)},$scope.findArtist=function(){$scope.searchArtist.indexOf(" ")!==-1&&($scope.searchArtist=$scope.searchArtist.replace(" ","-")),socket.emit("findArtist",{query:$scope.searchArtist}),$scope.searchArtist=""},playerFactory.isPlaying=!1,$scope.playBottom=function(){$scope.playListFinal[0]&&!playerFactory.isPlaying&&socket.emit("playNpause",{id:$scope.playListFinal[0].id,status:"play"})},$scope.playChosen=function(track){console.log(track.id),socket.emit("playNpause",{value:track,status:"playCurrSong"})},$scope.pause=function(){console.log("isPlaying"),playerFactory.isPlaying&&socket.emit("playNpause",{status:"pause"})},$scope.next=function(){socket.emit("playNpause",{status:"next"})},$scope.updateTyping=function(){$scope.typing=!0,socket.emit("typing",$cookies.get("username"));var lastTypingTime=(new Date).getTime();setTimeout(function(){var typingTimer=(new Date).getTime(),timeDiff=typingTimer-lastTypingTime;timeDiff>=$scope.TYPING_TIMER_LENGTH&&$scope.typing&&(socket.emit("stop typing"),$scope.typing=!1)},$scope.TYPING_TIMER_LENGTH)},$scope.chatMessages=[],$scope.checkTyping=!1,$scope.user=userName.name,$scope.typing=!1,$scope.TYPING_TIMER_LENGTH=4e3,$scope.chatSend=function(){var msg=JSON.stringify($scope.chatMsg);return msg=$.parseJSON(msg),msg&&socket.emit("chat message",{username:$cookies.get("username"),msg:msg}),$scope.chatMsg="",$scope.overflowCtrl("msg-output"),!1},$scope.overflowCtrl=function(id){window.setTimeout(function(){var elem=document.getElementById(id);elem.scrollTop=elem.scrollHeight},0)};var setSong=function(trackID){var trackSubmit=trackID.match(/\/tracks\/\d*/g);SC.stream(trackSubmit,function(audioObj){playerFactory.curSong=audioObj,console.log("audioobj inside next func",audioObj),playerFactory.isPlaying=!0,songHasFinished(),playerFactory.curSong.play()})},songHasFinished=function(){playerFactory.curSong._onfinish=function(){1===$scope.playListFinal.length?socket.emit("removeSong",{id:$scope.playListFinal[0]}):$scope.next()}};socket.on("removeSong",function(event){for(var i=0;i<$scope.playListFinal.length;i++)event.id.key===$scope.playListFinal[i].key&&(console.log(playerFactory.curSong),null!==playerFactory.curSong&&$scope.playListFinal[i].id===playerFactory.curSong.id.match(/\/tracks\/\d*/g).join("")&&(playerFactory.isPlaying=!1,playerFactory.curSong.stop()),$scope.playListFinal.splice(i,1));0===$scope.playListFinal.length&&playerFactory.isPlaying===!0&&playerFactory.curSong.stop()}),socket.on("findArtist",function(obj){var musicHandler=function(musicObj){if("object"!=typeof musicObj)throw err;$scope.playListFinal.push({key:songKeyTracker,id:"/tracks/"+musicObj.id,title:musicObj.title,artwork:musicObj.artwork_url||"http://www.clipartkid.com/images/10/girl-singing-clipart-Md6kBh-clipart.jpeg",name:musicObj.user.username,duration:musicObj.duration}),songKeyTracker++};soundService.getArtist(obj.query,musicHandler),$scope.overflowCtrl("playlist")}),socket.on("playNpause",function(obj){"playCurrSong"===obj.status&&(playerFactory.isPlaying===!0&&playerFactory.curSong.id!==obj.value.id&&(playerFactory.curSong.stop(),null===playerFactory.curSong),setSong(obj.value.id)),"play"===obj.status&&(console.log(playerFactory.curSong),playerFactory.curSong||(obj.id=$scope.playListFinal[0].id,console.log(obj.id),obj.id=obj.id.match(/\/tracks\/\d*/g),SC.stream(obj.id,function(audioObj){playerFactory.curSong=audioObj,console.log("audioobj inside play func",audioObj),songHasFinished()})),playerFactory.isPlaying=!0,playerFactory.curSong.play()),"pause"===obj.status&&(playerFactory.isPlaying=!1,playerFactory.curSong.pause()),"next"===obj.status&&($scope.playListFinal.shift(),obj.id=$scope.playListFinal[0].id,setSong(obj.id))}),socket.on("chat message",function(msg){console.log("socket on",msg),$scope.chatMessages.push(msg),$scope.overflowCtrl("msg-output")}),socket.on("typing",function(data){data.typing=!0,console.log($scope.user),$scope.typingMessage=data.name+" is typing",$scope.checkTyping=!0}),socket.on("stop typing",function(data){data.typing=!1,$scope.checkTyping=!1,$scope.typingMessage=""})}]),tune.controller("SplashController",["$scope","$location","socket","$cookies","userName",function($scope,$location,socket,$cookies,userName){$scope.submit=function(){$scope.text&&($cookies.put("username",$scope.text),userName.user($scope.text),socket.emit("username",$cookies.get("username")),$location.path("/home",!0))}}]),tune.factory("playerFactory",function(){var singleton={};return singleton.curSong=null,singleton.isPlaying=!1,SC.initialize({client_id:"8af4a50e36c50437ca44cd59756301ae"}),singleton}),tune.factory("socket",function($rootScope){var socket=io.connect();return{on:function(eventName,callback){socket.on(eventName,function(){var args=arguments;$rootScope.$apply(function(){callback.apply(socket,args)})})},emit:function(eventName,data,callback){socket.emit(eventName,data,function(){var args=arguments;$rootScope.$apply(function(){callback&&callback.apply(socket,args)})})}}}),tune.factory("soundService",function($http){var getArtist=function(tracknumber,cb){return SC.get("/tracks",{q:tracknumber},function(tracks){return cb(tracks.length>0?tracks[0]:"No songs found")})};return{getArtist:getArtist}}),tune.factory("userName",function(){var userSet={};return userSet.name="",userSet.user=function(userVal){userSet.name=userVal},userSet}),tune.directive("autofocus",["$timeout",function($timeout){return{restrict:"A",link:function($scope,$element){$timeout(function(){$element[0].focus()})}}}]);